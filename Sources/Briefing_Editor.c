/******************************************\|**| Briefing_Editor.c\******************************************/#pragma mark ¥¥INCLUDES¥¥/******************************************\|**| #includes\******************************************/#pragma mark _system includes_/* - system*******************************************/#pragma mark _third party includes_/* - third party libraries*******************************************/#pragma mark _bp libraries includes_/* - bp libraries*******************************************/// debug#include "Assert.h"#include "Window Dispatch.h"#include "Control Utilities.h"#include "str_bp.h"#include "Set Font By String.h"#include "BP_Error.h"#include "strlist.h"#include "List_Utilities.h"#include "PsuedoColumn_Utilities.h"#include "Classic2Carbon_Helpers.h"// hewey#include "Hewey.h"#include "Hewey_Main.h"#include "Hewey_Layout.h"#include "Hewey_Utilities.h"#include "Hewey_Helpers.h"#pragma mark _this library includes_/* - this project*******************************************/#include "Scenario.h"#include "Briefing_Editor.h"#include "Hera_Global.h"#include "Hera_Name_Maker.h"#include "Hera_Data.h"#include "Hera_Utilities.h"#include "STR_Editor.h"#include "TEXTEditor.h"#include "Button_Window.h"#include "Initial_Editor.h"#pragma mark ¥¥DEFINITIONS¥¥/******************************************\|**| #defines\******************************************//* - definitions*******************************************/#define	kTab_Width						50#define	kLarge_Tab_Width				112#define	kEditTextBigFieldWidth			150#define	kEditTextFieldWidth				50#define	kEditTextSmallFieldWidth		16#define	kColNum							2#define	kRowNum							4// separator cell// :master#define	kSeparator_Cell_X				0#define	kSeparator_Cell_Y				2#define	kSeparator_ID					200// list cell// :master#define	kList_Cell_X					0#define	kList_Cell_Y					0#define	kList_ID_Offset					300#define	kList_ID						(kList_ID_Offset + 2)// list button cell// :master#define	kList_Button_Cell_X				0#define	kList_Button_Cell_Y				1#define	kList_Button_ID_Offset			400#define	kList_Remove_Button_ID			(kList_Button_ID_Offset + 2)#define	kList_Add_Button_ID				(kList_Button_ID_Offset + 4)// button cell// :master#define	kButton_Cell_X					0#define	kButton_Cell_Y					3#define	kOK_Button_ID					1#define	kCancel_Button_ID				2#define	kRevert_Button_ID				3// main cell// :master#define	kMain_Cell_X					1#define	kMain_Cell_Y					0#define	kMain_ID_Offset					100#define	kMain_Master_ColNum				1#define	kMain_Master_RowNum				2// :master:mainMaster#define	kDetails_Type_Popup_ID			600#define	kDetails_Panel_Num				4#define	kDetails_Master_Cell_X			0#define	kDetails_Master_Cell_Y			0#define	kDetails_Master_ColNum			1#define	kDetails_Master_RowNum			1// :master:mainMaster:details#define	kDetails_Main_Cell_X			0#define	kDetails_Main_Cell_Y			0// :master:mainMaster:details#define	kOB_Panel_Index					kBriefObjectKind#define	kOB_ID_Offset					(kOB_Panel_Index * 2000)#define	kOB_objectNum					(kOB_ID_Offset + 2)#define	kOB_objectVisible				(kOB_ID_Offset + 4)#define	kOB_ChooseObject_Button			(kOB_ID_Offset + 6)// :master:mainMaster#define	kData_Cell_X					0#define	kData_Cell_Y					1#define	kData_Cell_ID_Offset			700#define	kData_Title_Field				(kData_Cell_ID_Offset + 2)#define	kData_Title_Choose_Button		(kData_Cell_ID_Offset + 4)#define	kData_Content_Field				(kData_Cell_ID_Offset + 6)#define	kData_Content_Choose_Button		(kData_Cell_ID_Offset + 8)#define	kSmallFontSize					gHera->smallFontSize#define	kSmallFontNum					gHera->smallFontNum#define	kLargeFontNum					gHera->bigFontNum;#define kLargeFontSize					gHera->bigFontSize;#define	kStrResID						8036#pragma mark _macros_/* - macros*******************************************/#pragma mark ¥¥TYPEDEFS¥¥/******************************************\|**| typedefs\******************************************/typedef struct Briefing_EditorWindowType{	heraScenarioFileType			*heraFile;	huiMasterControlType			*master;	huiMasterControlType			*details;	huiMasterControlType			*mainMaster;	long							windowID;	short							resRefNum;	long							briefPointFirst;	long							briefPointNum;	Handle							briefData;	Handle							discreteData;	long							whichBriefPoint;	briefPointType					brief;	short							dragTo;	short							dragFrom;	Handle							scenarioData;	long							scenarioIndex;	Briefing_Editor_Callback_procPtr	callBack;	long							discreteDataID;	long							callerID;	Boolean							chooseOnly;	long							initialID;} Briefing_EditorWindowType;#pragma mark ¥¥EXTERNAL GLOBALS¥¥/******************************************\|**| external globals\******************************************/extern heraGlobalType	*gHera;#pragma mark ¥¥PRIVATE GLOBALS¥¥/******************************************\|**| private globals\******************************************/#pragma mark ¥¥PRIVATE PROTOTYPES¥¥/******************************************\|**| private function prototypes\******************************************/static Boolean HandleEvent( EventRecord *, CWindowPtr, long, long);static Boolean ProcessMenuChoiceCommand( unsigned long menuData,		CWindowPtr whichWindow, long dispatchID);static Boolean ProcessEvent( EventRecord *theEvent,	CWindowPtr whichWindow, long dispatchID);static void Window_SetControls_FromBrief( Briefing_EditorWindowType *d,	CWindowPtr window, long index);static void Window_SetBrief_FromControls( Briefing_EditorWindowType *d,	CWindowPtr window, long index);static void SetBriefField( Briefing_EditorWindowType *d,	huiPlainControlParamType *dummyParam, briefPointType *i, long id,	Boolean draw);static void GetBriefField( Briefing_EditorWindowType *d,	huiPlainControlParamType *dummyParam, briefPointType *i, long id);static void TypePopup_Change( Briefing_EditorWindowType *d,	briefingPointKindType newKind, Boolean forceUpdate);static void List_Click( CWindowPtr whichWindow, Point where,	Briefing_EditorWindowType *d, ControlHandle aControl);static void OK_Button_From_WindowID( CWindowPtr whichWindow, long dispatchID);static void OK_Button( Briefing_EditorWindowType *d);static void Cancel_Button( Briefing_EditorWindowType *d);static void Revert_Button( Briefing_EditorWindowType *d);static void MakeBriefPointName( heraScenarioFileType *heraFile,	Handle briefData, long index, StringPtr s);static void Setup_List( Briefing_EditorWindowType *d);static OSErr Setup_Details_Panel( Briefing_EditorWindowType *d, CWindowPtr window);static pascal Boolean NullClickLoop( void);static void BriefTitle_CallBack( long windowID, long resID, long stringNum);static void Initial_Editor_CallBack( long dispatchID, long initialFirst,	long initialNum, long initialSelection, heraDataChangesType *changesList);static void Text_Editor_CallBack( long windowID, long resID);static void InsertBriefPoint( Briefing_EditorWindowType *d, CWindowPtr whichWindow);static void DeleteBriefPoint( Briefing_EditorWindowType *d, CWindowPtr whichWindow);static Handle InitialDiscreteData_Get( Briefing_EditorWindowType *d);static void Enable_Editing( Briefing_EditorWindowType *d, Boolean enable);#pragma mark ¥¥PRIVATE FUNCTIONS¥¥/******************************************\|**| private functions\******************************************/static Boolean HandleEvent( EventRecord *theEvent,	CWindowPtr whichWindow, long dispatchID, long command){	switch( command)	{		case kWDCloseWindowCommand:			break;				case kWDProcessEventCommand:			return( ProcessEvent( theEvent, whichWindow, dispatchID));			break;				case kWDSaveWindowCommand:			if (HU_ScenarioFiles_Equal( gHera->currentSave,				HU_HeraFile_Get_From_WindowID( dispatchID)))			{				if ( Button_Window_Modal( "\pSave changes to these briefing points?",										"\pBefore saving, the Briefing Point Editor "										"must be closed. Click Cancel to "										"abort the save.", nil, nil))				{					OK_Button_From_WindowID( whichWindow, dispatchID);									} else				{					gHera->currentSave = nil;				}			}			return false;			break;		case kWD_Close_ForQuit_Command:			if (HU_ScenarioFiles_Equal( gHera->currentSave,				HU_HeraFile_Get_From_WindowID( dispatchID)))			{				if ( Button_Window_Modal( "\pSave changes to these briefing points?",										"\pBefore quitting, the Briefing Point Editor "										"must be closed. Click Cancel to "										"abort the quit.", nil, nil))				{					OK_Button_From_WindowID( whichWindow, dispatchID);									} else				{					gHera->currentSave = nil;					return true;				}			}			return false;			break;		case kWDProcessMenuChoiceCommand:			return( ProcessMenuChoiceCommand( (unsigned long)theEvent,				whichWindow, dispatchID));			break;	}	return false;}static Boolean ProcessMenuChoiceCommand( unsigned long menuData,		CWindowPtr whichWindow, long dispatchID){	Handle							data = GetDispatchWindowDataHandle(																dispatchID);	SignedByte						dataState;	Briefing_EditorWindowType			*d;	Boolean							result = false;	GrafPtr							oldPort;	short							menuID = ((menuData & 0xffff0000) >> 16),									menuItem = (menuData & 0x0000ffff);										if ( data == nil) return false;	dataState = HGetState( data);	HLock( data);	d = (Briefing_EditorWindowType *)*data;	GetPort( &oldPort);	SetPortWindowPort( (WindowPtr)whichWindow);	result = Generic_ProcessMenuChoiceCommand( menuData, whichWindow,												dispatchID);	if ( result)	{		goto ProcessMenuChoiceCommand_Return;	}		switch( menuID)	{		case kEditMenuID:			switch( menuItem)			{				case kEdit_Undo_Item:					result = true;					break;				case kEdit_Add_Item:					result = true;					break;									case kEdit_Delete_Item:					result = true;					break;									case kEdit_Delete_All_Item:					result = true;					break;			}							break;		}	ProcessMenuChoiceCommand_Return:	SetPort( oldPort);	HSetState( data, dataState);	return( result);}static Boolean ProcessEvent( EventRecord *theEvent,	CWindowPtr whichWindow, long dispatchID){	Handle							data = GetDispatchWindowDataHandle( dispatchID);	SignedByte						dataState;	Boolean							result = false;	ControlHandle					aControl, oldControl;	short							whichPart, oldValue;	WindowPtr						scratchWindow;	Point							where;	char							whichChar;	GrafPtr							oldPort;	OSStatus						err;	Briefing_EditorWindowType				*d;		if ( data == nil) return false;	if ( theEvent == nil) return false;		dataState = HGetState( data);	HLock( data);	d = (Briefing_EditorWindowType *)*data;		if ( theEvent == nil) goto ProcessEvent_Return;		GetPort( &oldPort);	SetPortWindowPort( (WindowPtr)whichWindow);		switch( theEvent->what)	{		case nullEvent:			IdleControls( (WindowPtr)whichWindow);						result = true;			break;					case updateEvt:				BeginUpdate ((WindowPtr)whichWindow);/*			SetPort( (WindowPtr)whichWindow);			CalcVis( (WindowPtr)whichWindow);			UpdateControls( (WindowPtr)whichWindow, whichWindow->visRgn);*/			HU_GenericUpdateEventHandler( whichWindow);			EndUpdate ((WindowPtr)whichWindow);			result = true;			break;		case activateEvt:		{			Boolean	isActive = ((theEvent->modifiers & activeFlag) != 0);						if ( isActive)			{				if ( d->heraFile->fileRefNum > 0)					UseResFile( d->heraFile->fileRefNum);				else					UseResFile( gHera->default_scenarioFile_refNum);			}		}			// result != true so dispatch window will handle activation			// of controls etc.			break;					case mouseDown:			whichPart = FindWindow (theEvent->where, &scratchWindow);			switch( whichPart)			{				case inGrow:/*					{						Rect	growRect;						long	newSize;//						growRect = qd.screenBits.bounds;						C2C_ScreenBits_GetBounds( &growRect);						growRect.top = growRect.left = 120;						newSize = GrowWindow((WindowPtr)whichWindow,							theEvent->where ,&growRect);						if (newSize != 0)						{							SizeWindow( (WindowPtr)whichWindow, newSize & 0xffff,								(((newSize) >> 16) & 0xFFFF), true );							EraseRect(&whichWindow->portRect);							InvalRect( &whichWindow->portRect);						}					}*/					HU_GenericGrowWindow( whichWindow, theEvent->where);					result = true;					break;								case inContent:					where = theEvent->where;					scratchWindow = WD_FrontWindow();					if ( whichWindow != (CWindowPtr)scratchWindow)					{						goto ProcessEvent_Return;					}					SetPortWindowPort( (WindowPtr)whichWindow);					GlobalToLocal( &where);					whichPart = FindControl( where, (WindowPtr)whichWindow,						&aControl);					if ( aControl == nil)						goto ProcessEvent_Return;					if ( aControl != nil)						oldValue = GetControlValue( aControl);					err = GetKeyboardFocus( (WindowPtr)whichWindow, &oldControl);					if (( err == noErr) && ( oldControl != aControl))					{						SetKeyboardFocus( (WindowPtr)whichWindow, aControl, whichPart);					}					if ( whichPart != 0)					{						huiPlainControlType	*hui = (huiPlainControlType	*)CU_GetControlReference( aControl);//						whichPart = HandleControlClick ( aControl, where,//							theEvent->modifiers, (ControlActionUPP)-1);							if ( !ListBox_Appearance_1_0_1_Hack( aControl, where,									&whichPart))						{							whichPart = HUI_Control_Click_Handle( hui, where,								theEvent->modifiers);														}						if ( whichPart != kControlNoPart) switch( hui->generic.id)						{							case kOK_Button_ID:								result = true;								Window_SetBrief_FromControls( d, whichWindow, d->whichBriefPoint);								OK_Button( d);								data = nil;								goto ProcessEvent_Return;								break;														case kCancel_Button_ID:								Cancel_Button( d);								data = nil;								result = true;								goto ProcessEvent_Return;								break;														case kRevert_Button_ID:								Revert_Button( d);								break;															case kList_ID:								List_Click( whichWindow, where, d, aControl);								result = true;								break;														case kList_Add_Button_ID:								InsertBriefPoint( d, whichWindow);								result = true;								break;														case kList_Remove_Button_ID:								if ( HU_Confirm_Delete("\pAre you sure you "									"want to delete this briefing point?",										theEvent->modifiers))									DeleteBriefPoint( d, whichWindow);								result = true;								break;															case kData_Title_Choose_Button:								STR_Editor_NewWindow( d->heraFile,									"\pChoose Briefing Title",									d->resRefNum, d->brief.titleResID,									d->brief.titleNum, true, true,									true, dispatchID,									BriefTitle_CallBack);								result = true;								break;														case kDetails_Type_Popup_ID:								oldValue =									GetControlValue( aControl) - 1;								TypePopup_Change( d,									(briefingPointKindType)oldValue,									false);								result = true;								break;														case kOB_ChooseObject_Button:							{								Handle initialDiscreteData =										InitialDiscreteData_Get( d);																if ( initialDiscreteData != nil)								{									Initial_Editor_NewWindow( d->heraFile,										"\pChoose Initial Object",										d->resRefNum,										((heraDataHeaderType *)*initialDiscreteData)->id,										d->brief.briefPointData.objectBriefType.objectNum,										false, true, dispatchID,										Initial_Editor_CallBack);								}							}								result = true;								break;														case kData_Content_Choose_Button:								TEXTEditor_NewWindow( d->heraFile,										"\pChoose Briefing Point Content",										d->resRefNum, dispatchID,										d->brief.contentResID, true, true,										true, Text_Editor_CallBack);								result = true;								break;															default:								break;						}					} else // not in control					{						where = theEvent->where;						GlobalToLocal( &where);					}			}			break;					case keyDown:		case autoKey:			whichChar = theEvent->message & charCodeMask;			if ((whichChar=='\r' || whichChar==0x3))			{				// ok				long			soon = TickCount()+5;								aControl = HUI_Control_Get( d->master, 0, kButton_Cell_X,					kButton_Cell_Y, kOK_Button_ID);				if ( aControl != nil)				{					ActivateControl( aControl);					while ( TickCount() < soon){ /* do nothing */}					DeactivateControl( aControl);					result = true;					OK_Button( d);					data = nil;					goto ProcessEvent_Return;				}			} else if ((whichChar==0x1b) || ((whichChar=='.') && (theEvent->modifiers & cmdKey)))			{				// cancel				long			soon = TickCount()+5;								aControl = HUI_Control_Get( d->master, 0, kButton_Cell_X,					kButton_Cell_Y, kCancel_Button_ID);				if ( aControl != nil)				{					ActivateControl( aControl);					while ( TickCount() < soon){ /* do nothing */}					DeactivateControl( aControl);										Cancel_Button( d);					data = nil;					result = true;					goto ProcessEvent_Return;				}			} else if ( whichChar == '\t')			{				if ( theEvent->modifiers & shiftKey)					ReverseKeyboardFocus( (WindowPtr)whichWindow);				else					AdvanceKeyboardFocus( (WindowPtr)whichWindow);				result = true;				break;			} else if (( whichChar == 0x08) && ( !d->chooseOnly))			{				huiPlainControlType	*hui = nil;				err = GetKeyboardFocus( (WindowPtr)whichWindow, &aControl);				hui = (huiPlainControlType	*)CU_GetControlReference( aControl);				if ( hui != nil)				{					if ( hui->generic.id == kList_ID)					{						if ( HU_Confirm_Delete("\pAre you sure you "							"want to delete this briefing point?",								theEvent->modifiers))							DeleteBriefPoint( d, whichWindow);					}				}				result = true;			}						err = GetKeyboardFocus( (WindowPtr)whichWindow, &aControl);			if (( err == noErr) && ( aControl != nil))			{				whichPart = HandleControlKey( aControl,					(theEvent->message & keyCodeMask)>>16,					theEvent->message & charCodeMask, theEvent->modifiers);				{					huiGenericControlType	*hui =						(huiGenericControlType *)CU_GetControlReference( aControl);					ListHandle				list;										if ( hui->kind != hui_ScrollTextControl) whichPart =						kControlNoPart;										switch( hui->id)					{						case kList_ID:							oldValue = d->whichBriefPoint;							d->whichBriefPoint = HUI_Control_GetListValue(										d->master, 0, kList_Cell_X,										kList_Cell_Y,										kList_ID, d->whichBriefPoint);							list = HUI_List_Get(  d->master, 0,								kList_Cell_X, kList_Cell_Y, kList_ID);							if (( list != nil) && ( d->whichBriefPoint !=								oldValue))							{								Window_SetBrief_FromControls( d, whichWindow, oldValue);								Window_SetControls_FromBrief(									d, whichWindow, d->whichBriefPoint);							}							break;					}				}			}			break;	}		ProcessEvent_Return:	SetPort( oldPort);	if ( data != nil)		HSetState( data, dataState);	return( result);	}static void Window_SetControls_FromBrief( Briefing_EditorWindowType *d,	CWindowPtr window, long index){	SignedByte					briefDataState;	GrafPtr						oldPort;	briefPointType		*aBrief;	huiPlainControlParamType	dummyParam;		mAssert( d != nil);		if (( d->briefData == nil) || ( d->briefPointNum <= 0)) return;		mAssert( d->briefData != nil);		briefDataState = HGetState( d->briefData);	HLock( d->briefData);	GetPort( &oldPort);	SetPortWindowPort( (WindowPtr)window);		aBrief = (briefPointType *)*d->briefData + index;		TypePopup_Change( d, aBrief->briefPointKind, false);	BlockMoveData( aBrief, &d->brief, sizeof( briefPointType));	// set data	dummyParam.layer = 0;	dummyParam.cellx = kData_Cell_X;	dummyParam.celly = kData_Cell_Y;	dummyParam.master = d->mainMaster;		SetBriefField( d, &dummyParam, aBrief, kData_Title_Field, true);	SetBriefField( d, &dummyParam, aBrief, kData_Content_Field, true);	// set details menu	dummyParam.layer = 0;	dummyParam.cellx = kDetails_Master_Cell_X;	dummyParam.celly = kDetails_Master_Cell_Y;	dummyParam.master = d->mainMaster;	SetBriefField( d, &dummyParam, aBrief, kDetails_Type_Popup_ID, true);	// set object type panel	dummyParam.layer = kOB_Panel_Index;	dummyParam.cellx = kDetails_Main_Cell_X;	dummyParam.celly = kDetails_Main_Cell_Y;	dummyParam.master = d->details;	SetBriefField( d, &dummyParam, aBrief, kOB_objectNum, true);	SetBriefField( d, &dummyParam, aBrief, kOB_objectVisible, true);	HSetState( d->briefData, briefDataState);}static void Window_SetBrief_FromControls( Briefing_EditorWindowType *d,	CWindowPtr window, long index){	SignedByte					briefDataState;	GrafPtr						oldPort;	briefPointType		*aBrief;	huiPlainControlParamType	dummyParam;	Str255						s;		mAssert( d != nil);	if (( d->briefData == nil) || ( d->briefPointNum <= 0)) return;	if ( d->chooseOnly) return;		mAssert( d->briefData != nil);		briefDataState = HGetState( d->briefData);	HLock( d->briefData);	GetPort( &oldPort);	SetPortWindowPort( (WindowPtr)window);		aBrief = (briefPointType *)*d->briefData + index;		BlockMoveData( &d->brief, aBrief, sizeof( briefPointType));	// set qualifiers	dummyParam.layer = 0;	dummyParam.cellx = kData_Cell_X;	dummyParam.celly = kData_Cell_Y;	dummyParam.master = d->mainMaster;		GetBriefField( d, &dummyParam, aBrief, kData_Title_Field);	GetBriefField( d, &dummyParam, aBrief, kData_Content_Field);	// object type panel	dummyParam.layer = kOB_Panel_Index;	dummyParam.cellx = kDetails_Main_Cell_X;	dummyParam.celly = kDetails_Main_Cell_Y;	dummyParam.master = d->details;//	GetBriefField( d, &dummyParam, aBrief, kOB_objectNum);	GetBriefField( d, &dummyParam, aBrief, kOB_objectVisible);		MakeBriefPointName( d->heraFile, d->briefData, index, s);	HUI_Control_SetListCell( 		d->master, 0, kList_Cell_X, kList_Cell_Y,		kList_ID, 0, index,		(Ptr)&s[1], s[0]);	HUI_Control_Draw( d->master, 0, kList_Cell_X, kList_Cell_Y,		kList_ID);		BlockMoveData( aBrief, &d->brief, sizeof( briefPointType));	HSetState( d->briefData, briefDataState);}static void SetBriefField( Briefing_EditorWindowType *d,	huiPlainControlParamType *dummyParam, briefPointType *b, long id,	Boolean draw){	ControlHandle	aControl;	Str255			s;		if ( dummyParam == nil) return;	if ( b == nil) return;	if ( id < 0) return;		aControl = HUI_Control_Get( dummyParam->master, dummyParam->layer, dummyParam->cellx,		dummyParam->celly, id);	if ( aControl == nil) return;		switch( id)	{		case kData_Title_Field:			HU_GetOneIndString( d->heraFile, b->titleResID, b->titleNum, s);			SetControlTextItemString( aControl, s);			break;			case kData_Content_Field:			SetControlTextItemString( aControl,				HNM_Resource_Name_Make( d->heraFile, 'TEXT', b->contentResID, s));			break;				case kOB_objectNum:			if ( b->briefPointKind == kBriefObjectKind)			{				scenarioType	*scenario = (scenarioType *)*d->scenarioData									+ d->scenarioIndex;				long			offset, size;				Handle			initialDiscreteData = nil;				scenarioInitialType	initial, *initialPtr;								initialDiscreteData = HD_Find_Discrete_Data(											d->heraFile, 											d->initialID, -1, nil,											//scenario->initialFirst,											//scenario->initialNum, nil,											kHera_Initial_Type);				if ( initialDiscreteData != nil)				{					HD_DiscreteData_GetOffsetAndSize( initialDiscreteData,						&offset, &size);										initialPtr = (scenarioInitialType *)((*initialDiscreteData +						offset + (sizeof( scenarioInitialType) *						b->briefPointData.objectBriefType.objectNum)));										initial = *initialPtr;					MakeInitialName( d->heraFile, &initial, nil,						b->briefPointData.objectBriefType.objectNum, nil, nil, s);				} else					pstrcpy( s, "\pÑ");				SetControlTextItemString( aControl, s);			}			break;				case kOB_objectVisible:			if ( b->briefPointKind == kBriefObjectKind)			{				SetControlValue( aControl,					b->briefPointData.objectBriefType.objectVisible);			}			break;					case kDetails_Type_Popup_ID:			SetControlValue( aControl, b->briefPointKind + 1);			break;			}	if ( draw) Draw1Control( aControl);}static void GetBriefField( Briefing_EditorWindowType *d,	huiPlainControlParamType *dummyParam, briefPointType *b, long id){	ControlHandle	aControl;#pragma unused ( d)	if ( dummyParam == nil) return;	if ( b == nil) return;	if ( id < 0) return;		aControl = HUI_Control_Get( dummyParam->master, dummyParam->layer, dummyParam->cellx,		dummyParam->celly, id);	if ( aControl == nil) return;	switch( id)	{	}}static void TypePopup_Change( Briefing_EditorWindowType *d,	briefingPointKindType newKind, Boolean forceUpdate){	long	oldPanel = d->brief.briefPointKind;		d->brief.briefPointKind = newKind;	if (( newKind != oldPanel) || ( forceUpdate))	{		if ( oldPanel >= 0)		{			HUI_Master_HideLayer( d->details, oldPanel);		}		HUI_Master_ShowLayer( d->details, d->brief.briefPointKind);	}		HU_AutoDefocus( GetWindowPtrFromDispatchWindowID( d->windowID));}static void List_Click( CWindowPtr whichWindow, Point where,	Briefing_EditorWindowType *d, ControlHandle aControl){	ListHandle				list;	short					shortLength = 0, oldValue, dragTo, dragFrom;	Ptr						data = nil;	briefPointType			aBrief;		GetListBoxListHandle( aControl, &list);	if ( list == nil) return;		if ( d->chooseOnly)		dragTo = -1;	else		dragTo =  List_Reposition_Drag( list, where, aControl);	oldValue = d->whichBriefPoint;		dragFrom = d->whichBriefPoint = HUI_Control_GetListValue(			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, d->whichBriefPoint);	{			}	if ( d->whichBriefPoint != oldValue)	{		Window_SetBrief_FromControls( d, whichWindow, oldValue);		Window_SetControls_FromBrief(			d, whichWindow, d->whichBriefPoint);				}		if ( dragTo != -1)	{		d->dragTo = dragTo;		d->dragFrom = dragFrom;				data = List_Utilities_GetCell( list, (Point){dragFrom, 0}, &shortLength);		if ( data != nil)		{			LDelRow( 1, dragFrom, list);			if ( dragFrom < dragTo) dragTo--;			LAddRow( 1, dragTo, list);			LSetCell( data, shortLength, (Point){dragTo, 0}, list);			DisposePtr( data);			d->whichBriefPoint = HUI_Control_SetListValue( d->master, 0,				kList_Cell_X, kList_Cell_Y, kList_ID, dragTo);			DisposePtr( data);						HU_Data_CopyFromHandle( (Ptr)&aBrief, d->briefData, dragFrom,				sizeof( briefPointType));							HU_Handle_DeleteData( dragFrom, d->briefData, sizeof( briefPointType),				0);						HU_Handle_InsertData( dragTo, d->briefData, (Ptr)&aBrief,				sizeof( briefPointType), 0); 		}		Draw1Control( aControl);			}		}static void OK_Button_From_WindowID( CWindowPtr whichWindow, long dispatchID){	Handle							data = GetDispatchWindowDataHandle( dispatchID);	SignedByte						dataState;	Briefing_EditorWindowType		*d;		if ( data == nil) return;		dataState = HGetState( data);	HLock( data);	d = (Briefing_EditorWindowType *)*data;	Window_SetBrief_FromControls( d, whichWindow, d->whichBriefPoint);	OK_Button( d);	// data has been deleted; window is closed}static void OK_Button( Briefing_EditorWindowType *d){	Boolean				same = true;		gHera->modalMode--;	if (( d->discreteData != nil) && ( d->briefData != nil))	{		HD_DiscreteData_Replace_Compare( d->discreteData, d->briefData,			kHera_BriefPoint_Type, &same);				if ( !same) d->heraFile->changed = true;		DisposeHandle( d->briefData);	}		if ( d->callBack != nil) d->callBack( d->callerID, d->discreteDataID,		d->briefPointNum);			HUI_MasterControl_Delete( d->master);	CloseDispatchWindow( d->windowID);}static void Cancel_Button( Briefing_EditorWindowType *d){	gHera->modalMode--;	HUI_MasterControl_Delete( d->master);	CloseDispatchWindow( d->windowID);}static void Revert_Button( Briefing_EditorWindowType *d){	CWindowPtr whichWindow = GetWindowPtrFromDispatchWindowID( d->windowID);		if ( whichWindow == nil) return;	if ( !Button_Window_Modal( "\pRevert this Briefing Point?",							"\pClick Revert to restore this briefing point to its "							"previous values. Click Cancel to "							"keep it as it is.", "\pRevert", nil))		return;		Window_SetControls_FromBrief( d, whichWindow, d->whichBriefPoint);}static void MakeBriefPointName( heraScenarioFileType *heraFile,	Handle briefData, long index, StringPtr s){	briefPointType		*b;		if ( s == nil) return;	if ( briefData == nil) pstrcpy( s, "\p<untitled>");	b = (briefPointType *)*briefData + index;		HU_GetOneIndString( heraFile, b->titleResID, b->titleNum, s);	if ( s[0] == 0)		pstrcpy(s, "\p-");}static void Setup_List( Briefing_EditorWindowType *d){	short						oldResRefNum = 0;	ControlHandle				aControl;	ListHandle					list;	long						briefNum = 0;		if ( d == nil) return;	oldResRefNum = CurResFile();	if ( d->heraFile->fileRefNum > 0)		UseResFile( d->heraFile->fileRefNum);	else		UseResFile( gHera->default_scenarioFile_refNum);//	UseResFile( d->resRefNum);		if ( d->briefData == nil)	{		long	offset, size;		if ( d->briefData != nil) DisposeHandle( d->briefData);				HD_DiscreteData_GetOffsetAndSize( d->discreteData, &offset, &size);		d->briefData = NewHandle( size);		if ( d->briefData == nil) goto Setup_List_error;		BlockMove( *d->discreteData + offset, *d->briefData, size);	}	if ( d->briefData == nil)	{		goto Setup_List_error;	}		aControl = HUI_Control_Get( 		d->master, 0, kList_Cell_X, kList_Cell_Y,		kList_ID);	if ( aControl != nil)	{		Cell		cell;				d->briefPointNum = briefNum = GetHandleSize( d->briefData) / sizeof( briefPointType);		if ( briefNum > 0)		{			if ( d->briefPointFirst >= briefNum) d->briefPointFirst = briefNum - 1;			if (( d->briefPointFirst + d->briefPointNum) > briefNum)				d->briefPointNum = (briefNum - d->briefPointFirst);		} else d->briefPointFirst = 0;		GetListBoxListHandle( aControl, &list);			if ( list != nil)		{			short	i = d->briefPointFirst, count = d->briefPointNum;			Str255	s;						LDelRow( 0, 0, list);	// delete all rows//			List_ClickLoopProc_Install( list, NullClickLoop);			ImmediateReturn_ClickLoop_Install( list);			(*list)->selFlags = lOnlyOne;						cell.h = 0;			while ( count > 0)			{//				GetIndString( s, 4201, i);				MakeBriefPointName( d->heraFile, d->briefData, i, s);				if ( s[0] == 0) pstrcpy( s, "\puntitled");//				if ( s[0] != 0)				{					LAddRow( 1, (**list).dataBounds.bottom, list );					cell.v = (**list).dataBounds.bottom - 1;					LSetCell( (Ptr)(&s[1]), s[0], cell, list );				}				i ++;				count--;			}		}	}	briefNum = GetHandleSize( d->briefData) / sizeof( briefPointType);	if ( d->whichBriefPoint >= briefNum) d->whichBriefPoint = briefNum - 1;	d->whichBriefPoint = HUI_Control_SetListValue( d->master, 0, kList_Cell_X, kList_Cell_Y,										kList_ID, d->whichBriefPoint);//	Window_SetControls_FromActionIndex( d,//		GetWindowPtrFromDispatchWindowID( d->windowID), d->whichAction + d->startActionIndex);	Setup_List_error:		UseResFile( oldResRefNum);}static OSErr Setup_Details_Panel( Briefing_EditorWindowType *d, CWindowPtr window){	huiPlainControlParamType	buttonParam, textParam;	huiCellParamType			cellParam;	short						i;#pragma unused ( window)		// set up all cells	cellParam.master = d->details;	cellParam.baseLine = -1;	cellParam.hAlign = hui_halign_center;	cellParam.vAlign = hui_valign_center;	cellParam.flags = huiControlFlag_none;	SetRect( &cellParam.minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);	SetRect( &cellParam.outSpace, -1, -1, -1, -1);	SetRect( &cellParam.inSpace, -1, -1, -1, -1);	// set up main cell	for ( i = 0; i < kDetails_Panel_Num; i++)	{		cellParam.colSpan = 1;		cellParam.rowSpan = 1;		SetRect( &cellParam.outSpace, -1, -1, -1, 20);		HUI_Cell_Set( i, kDetails_Main_Cell_X, kDetails_Main_Cell_Y, &cellParam);		SetRect( &cellParam.outSpace, -1, -1, -1, -1);	}	// set up buttons, general	buttonParam.master = d->details;	buttonParam.visible = true;	buttonParam.enabled = true;	buttonParam.layer = 0;	buttonParam.whichTabSet = -1;	buttonParam.whichTab = -1;	buttonParam.minMaxBounds.left = 0;	buttonParam.minMaxBounds.top = 0;	buttonParam.minMaxBounds.right = kHUI_Pixel_Max;	buttonParam.minMaxBounds.bottom = kHUI_Pixel_Max;	buttonParam.space.left = 4;	buttonParam.space.top = 8;	buttonParam.space.bottom = 4;	buttonParam.fontStyle.flags = kControlUseFontMask | kControlUseSizeMask |		kControlUseFaceMask;	buttonParam.fontStyle.font = kSmallFontNum;	buttonParam.fontStyle.size = kSmallFontSize;	buttonParam.fontStyle.style = 0;	buttonParam.fontStyle.just = teCenter;	buttonParam.helpStringResID = -1;	buttonParam.enabledOnIndex = -1;	buttonParam.enabledOffIndex = -1;	buttonParam.disabledIndex = -1;	buttonParam.flags = huiControlFlag_none;	buttonParam.cellx = kDetails_Main_Cell_X;	buttonParam.celly = kDetails_Main_Cell_Y;		// set up text, general		textParam.master = d->details;	textParam.visible = true;	textParam.enabled = true;	textParam.layer = 0;	textParam.whichTabSet = -1;	textParam.whichTab = -1;	textParam.minMaxBounds.left = 0;	textParam.minMaxBounds.top = 0;	textParam.minMaxBounds.right = kHUI_Pixel_Max;	textParam.minMaxBounds.bottom = kHUI_Pixel_Max;	textParam.space.left = 8;	textParam.space.top = 12;	textParam.space.bottom = 4;	textParam.flags = huiControlFlag_none;	textParam.fontStyle.flags = kControlUseFontMask | kControlUseSizeMask |		kControlUseFaceMask;// | kControlUseJustMask;	textParam.fontStyle.font = gHera->smallFontNum;	textParam.fontStyle.size = gHera->smallFontSize;	textParam.fontStyle.style = 0;	textParam.fontStyle.just = -1;	textParam.cellx = kDetails_Main_Cell_X;	textParam.celly = kDetails_Main_Cell_Y;	textParam.helpStringResID = -1;	textParam.enabledOnIndex = -1;	textParam.enabledOffIndex = -1;	textParam.disabledIndex = -1;	if ( d->chooseOnly) buttonParam.enabled = false;	if ( d->chooseOnly) textParam.enabled = false;		// ----------------------------------	// create object panel	// ----------------------------------	textParam.layer = kOB_Panel_Index;	buttonParam.layer = kOB_Panel_Index;	// object label	textParam.minMaxBounds.left = 0;	textParam.id = kOB_objectNum -1;	GetIndString( textParam.label, kStrResID, 3); // object	textParam.whichTabSet = 0;	textParam.whichTab = 0;	textParam.flags = huiControlFlag_newLine;	HUI_StaticText_New_LiteralP( &textParam);		// object field	textParam.id = kOB_objectNum;	textParam.minMaxBounds.left = kEditTextBigFieldWidth;	textParam.flags = huiControlFlag_none;	textParam.whichTabSet = 0;	textParam.whichTab = 1;	textParam.label[0] = 0;	HUI_StaticText_New_LiteralP( &textParam);	textParam.minMaxBounds.left = 0;		buttonParam.id = kOB_ChooseObject_Button;	GetIndString( buttonParam.label, kStrResID, 6); // choose object	buttonParam.flags = huiControlFlag_none;	buttonParam.whichTabSet = -1;	buttonParam.whichTab = -1;	HUI_PushButton_New_LiteralP( &buttonParam);		buttonParam.id = kOB_objectVisible;	buttonParam.flags = huiControlFlag_newLine;	GetIndString( buttonParam.label, kStrResID, 4); // visible	buttonParam.whichTabSet = 0;	buttonParam.whichTab = 1;	buttonParam.enabled = false;	HUI_CheckBox_New_LiteralP( &buttonParam);		return noErr;}static pascal Boolean NullClickLoop( void){	return false;}static void BriefTitle_CallBack( long windowID, long resID, long stringNum){	Handle						windowData =									GetDispatchWindowDataHandle( windowID);	SignedByte					dataState;	Briefing_EditorWindowType	*d;	huiPlainControlParamType	dummyParam;		if ( windowData == nil) return;	dataState = HGetState( windowData);	HLock( windowData);	d = (Briefing_EditorWindowType *)*windowData;		d->brief.titleResID = resID;	d->brief.titleNum = stringNum;		dummyParam.master = d->mainMaster;	dummyParam.layer = 0;	dummyParam.cellx = kData_Cell_X;	dummyParam.celly = kData_Cell_Y;			SetBriefField( d, &dummyParam, &d->brief, kData_Title_Field,						true);	HSetState( windowData, dataState);}static void Initial_Editor_CallBack( long dispatchID, long initialFirst,	long initialNum, long initialSelection, heraDataChangesType *changesList){	Handle						windowData =									GetDispatchWindowDataHandle( dispatchID);	SignedByte					dataState;	Briefing_EditorWindowType	*d;	huiPlainControlParamType	dummyParam;#pragma unused ( initialFirst, initialNum, changesList)		if ( windowData == nil) return;	dataState = HGetState( windowData);	HLock( windowData);	d = (Briefing_EditorWindowType *)*windowData;		d->brief.briefPointData.objectBriefType.objectNum = initialSelection;		dummyParam.layer = kOB_Panel_Index;	dummyParam.cellx = kDetails_Main_Cell_X;	dummyParam.celly = kDetails_Main_Cell_Y;	dummyParam.master = d->details;			SetBriefField( d, &dummyParam, &d->brief, kOB_objectNum,						true);	HSetState( windowData, dataState);}static void Text_Editor_CallBack( long windowID, long resID){	Handle						windowData =									GetDispatchWindowDataHandle( windowID);	SignedByte					dataState;	Briefing_EditorWindowType	*d;	huiPlainControlParamType	dummyParam;		if ( windowData == nil) return;	dataState = HGetState( windowData);	HLock( windowData);	d = (Briefing_EditorWindowType *)*windowData;		d->brief.contentResID = resID;		dummyParam.layer = 0;	dummyParam.cellx = kData_Cell_X;	dummyParam.celly = kData_Cell_Y;	dummyParam.master = d->mainMaster;			SetBriefField( d, &dummyParam, &d->brief, kData_Content_Field,						true);							HSetState( windowData, dataState);}static void InsertBriefPoint( Briefing_EditorWindowType *d, CWindowPtr whichWindow){	Ptr					data = nil;	long				dataLength;	ControlHandle		aControl;	Str255				s;		d->heraFile->changed = true;		Window_SetBrief_FromControls( d,		whichWindow, d->whichBriefPoint + d->briefPointFirst);		if ( d->briefPointNum > 0)	{		HUI_Control_GetListCell( 			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, 0, d->whichBriefPoint,			&data, &dataLength);				HU_Handle_InsertData( d->whichBriefPoint, d->briefData, (Ptr)&d->brief,			sizeof( briefPointType), 0);		HUI_Control_InsertListRows(			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, 1, d->whichBriefPoint);		if ( data != nil)		{			HUI_Control_SetListCell( 				d->master, 0, kList_Cell_X, kList_Cell_Y,				kList_ID, 0, d->whichBriefPoint,				data, dataLength);						DisposePtr( data);		}		d->briefPointNum++;		d->whichBriefPoint++;		Setup_List( d); // this will correctly set list cells & selection	} else	{		d->briefPointNum = 1;			d->brief.briefPointKind = kNoPointKind;		d->brief.contentResID = -1;		d->brief.titleNum = -1;		d->brief.titleResID = -1;		d->brief.range.h = d->brief.range.v = 0;		d->brief.briefPointData.absoluteBriefType.location.h = 0;		d->brief.briefPointData.absoluteBriefType.location.v = 0;		HU_Handle_InsertData( d->whichBriefPoint, d->briefData, (Ptr)&d->brief,			sizeof( briefPointType), 0);		MakeBriefPointName( d->heraFile, d->briefData, 0, s);				d->whichBriefPoint = 0;				HUI_Control_InsertListRows(			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, 1, d->whichBriefPoint);				HUI_Control_SetListCell( 			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, 0, d->whichBriefPoint,			(Ptr)&s[1], s[0]);		Window_SetControls_FromBrief(			d, whichWindow, d->whichBriefPoint + d->briefPointFirst			);				Enable_Editing( d, true);	}	d->whichBriefPoint = 		HUI_Control_GetListValue(			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, d->whichBriefPoint);	aControl = HUI_Control_Get( 		d->master, 0, kList_Cell_X, kList_Cell_Y,		kList_ID);	if ( aControl != nil)	{		Draw1Control( aControl);	}	}static void DeleteBriefPoint( Briefing_EditorWindowType *d, CWindowPtr whichWindow){	ControlHandle	aControl;	ListHandle		list;#pragma unused( whichWindow)		if ( d->briefPointNum <= 0) return;		d->heraFile->changed = true;		HU_Handle_DeleteData( d->whichBriefPoint, d->briefData,		sizeof( briefPointType), 0);		HUI_Control_DeleteListRows(		d->master, 0, kList_Cell_X, kList_Cell_Y,		kList_ID, 1, d->whichBriefPoint);	d->whichBriefPoint = 		HUI_Control_SetListValue(			d->master, 0, kList_Cell_X, kList_Cell_Y,			kList_ID, d->whichBriefPoint);	aControl = HUI_Control_Get( 		d->master, 0, kList_Cell_X, kList_Cell_Y,		kList_ID);	if ( aControl != nil)	{				GetListBoxListHandle( aControl, &list);		if ( list != nil)		{			LAutoScroll(list);		}		Draw1Control( aControl);	}		d->briefPointNum--;	if ( d->briefPointNum <= 0) Enable_Editing( d, false);		Setup_List( d);}static Handle InitialDiscreteData_Get( Briefing_EditorWindowType *d){	scenarioType	*scenario = (scenarioType *)*d->scenarioData						+ d->scenarioIndex;//	Handle			initialDiscreteData = nil;		return HD_Find_Discrete_Data( d->heraFile, d->initialID, -1, nil,								//scenario->initialFirst,								//scenario->initialNum, nil,								kHera_Initial_Type);}static void Enable_Editing( Briefing_EditorWindowType *d, Boolean enable){	HUI_Cell_Set_Enabled( d->master, 0, kMain_Cell_X, kMain_Cell_Y, enable);}#pragma mark ¥¥PUBLIC FUNCTIONS¥¥/******************************************\|**| public functions\******************************************/OSErr Briefing_Editor_NewWindow( heraScenarioFileType *heraFile, 	StringPtr title, short resRefNum, long briefPointFirst,	long briefPointNum, Handle discreteData, Handle scenarioData,	long scenarioIndex, long initialID, long callerID, long discreteDataID,	Briefing_Editor_Callback_procPtr callBack){	Rect						bounds;	CWindowPtr					newWindow;	ControlHandle				rootControl, aControl;	huiPlainControlParamType	buttonParam, textParam, groupParam;	huiMasterControlParamType	masterParam;	OSStatus					err;	Handle						data, strList;	Briefing_EditorWindowType	*d;	long						maxWidth = 0, windowID = -1, i;	huiCellParamType			cellParam;	#pragma unused ( err, textParam, aControl, scenarioData, scenarioIndex)		if ( discreteData != nil)	{		long	offset, size;				HD_DiscreteData_GetOffsetAndSize( discreteData, &offset, &size);		briefPointFirst = 0;		briefPointNum = size / sizeof( briefPointType);	}		// create the new window	data = NewHandle( sizeof( Briefing_EditorWindowType));	if ( data == nil) return memFullErr;		HLock( data);	d = (Briefing_EditorWindowType *)*data;	d->resRefNum = resRefNum;	d->briefPointFirst = briefPointFirst;	d->briefPointNum = briefPointNum;	d->whichBriefPoint = -1;	d->discreteData = discreteData;	d->briefData = nil;	d->scenarioData = scenarioData;	d->scenarioIndex = scenarioIndex;	d->initialID = initialID;	d->callBack = callBack;	d->discreteDataID = discreteDataID;	d->callerID = callerID;	d->heraFile = heraFile;	if ( heraFile->fileRefNum > 0)		d->chooseOnly = false;	else		d->chooseOnly = true;			SetRect( &bounds, 64, 64, 128, 128);	newWindow = NewDispatchWindow( &bounds, title, false,		kWindowMovableModalDialogProc, (WindowPtr)-1, false,		HandleEvent, 0,		&windowID);	SetDispatchWindowDataHandle( windowID, data);	d->windowID = windowID;		SetThemeWindowBackground( (WindowPtr)newWindow,		kThemeActiveDialogBackgroundBrush, true);	SetPortWindowPort( (WindowPtr)newWindow);	CreateRootControl( (WindowPtr)newWindow, &rootControl);	masterParam.control = &buttonParam;	masterParam.control->layer = 0;	masterParam.control->id = 0;	masterParam.control->flags = huiControlFlag_none;	SetRect( &masterParam.control->minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);	masterParam.window = newWindow;	masterParam.rowNum = kRowNum;	masterParam.colNum = kColNum;	masterParam.layerNum = 1;	SetRect( &masterParam.inSpace, 6, 6, 6, 6);	SetRect( &masterParam.outSpace, 6, 6, 6, 6);	SetRect( &masterParam.controlSpace, 6, 6, 6, 6);	SetRect( &masterParam.minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);	masterParam.baseLine = kSmallFontSize;	d->master = HUI_MasterControl_New( nil, 0, 0, 0, &masterParam);		mAssert( d->master != nil);	if ( d->master == nil) return memFullErr;	HUI_Master_ShowLayer( d->master, 0);	d->master->tab[0][0].h = 112;	d->master->tab[0][0].hAlign = hui_halign_right;	cellParam.master = d->master;	cellParam.baseLine = -1;	cellParam.hAlign = hui_halign_center;	cellParam.vAlign = hui_valign_top;	cellParam.flags = huiControlFlag_none;	SetRect( &cellParam.minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);	SetRect( &cellParam.outSpace, -1, -1, -1, -1);	SetRect( &cellParam.inSpace, -1, -1, -1, -1);	// set up main cell	cellParam.colSpan = 1;	cellParam.rowSpan = 2;	cellParam.vAlign = hui_valign_center;	SetRect( &cellParam.outSpace, 0, 0, 0, 0);	SetRect( &cellParam.inSpace, 0, 0, 0, 0);	HUI_Cell_Set( 0, kMain_Cell_X, kMain_Cell_Y, &cellParam);	// separator	cellParam.minMaxBounds.right = kHUI_Pixel_Max;		// set up list cell	SetRect( &cellParam.outSpace, 12, -1, -1, 5);	SetRect( &cellParam.inSpace, 3, -1, 3, 3);	cellParam.colSpan = 1;	cellParam.rowSpan = 1;	cellParam.hAlign = hui_halign_right;	cellParam.minMaxBounds.top = 100;	HUI_Cell_Set( 0, kList_Cell_X, kList_Cell_Y, &cellParam);	cellParam.minMaxBounds.top = 0;	cellParam.minMaxBounds.top = 0;		// set up list button cells	SetRect( &cellParam.inSpace, -1, -1, -1, -1);	SetRect( &cellParam.outSpace, -1, -1, -1, -1);	cellParam.colSpan = 1;	cellParam.rowSpan = 1;	cellParam.baseLine = gHera->smallFontSize;	cellParam.hAlign = hui_halign_center;	d->master->rowDontExpand[kList_Button_Cell_Y] = true;	HUI_Cell_Set( 0, kList_Button_Cell_X, kList_Button_Cell_Y, &cellParam);	cellParam.minMaxBounds.bottom = kHUI_Pixel_Max;	// set up main sub-master	masterParam.control = &buttonParam;	masterParam.control->layer = 0;	masterParam.control->id = 0;	masterParam.control->flags = huiControlFlag_none;	SetRect( &masterParam.control->minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);	masterParam.window = newWindow;	masterParam.rowNum = kMain_Master_RowNum;	masterParam.colNum = kMain_Master_ColNum;	masterParam.layerNum = 1;	SetRect( &masterParam.inSpace, 6, 6, 6, 6);	SetRect( &masterParam.outSpace, 6, 6, 6, 6);	SetRect( &masterParam.controlSpace, 6, 6, 6, 6);	SetRect( &masterParam.minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);	masterParam.baseLine = kSmallFontSize;		d->mainMaster = HUI_MasterControl_New( d->master, 0, kMain_Cell_X,		kMain_Cell_Y, &masterParam);	mAssert( d->mainMaster != nil);	if ( d->mainMaster == nil) return memFullErr;	HUI_Master_HideLayer( d->mainMaster, 0);	d->mainMaster->tab[0][0].h = kTab_Width;	d->mainMaster->tab[0][0].hAlign = hui_halign_right;	d->mainMaster->tab[0][1].h = kTab_Width;	d->mainMaster->tab[0][1].hAlign = hui_halign_left;	// set up main master cells	cellParam.master = d->mainMaster;	cellParam.colSpan = 1;	cellParam.rowSpan = 1;	cellParam.hAlign = hui_halign_center;	SetRect( &cellParam.outSpace, -1, -1, 12, -1);	SetRect( &cellParam.inSpace, -1, -1, -1, -1);	HUI_Cell_Set( 0, kData_Cell_X, kData_Cell_Y, &cellParam);	HUI_Cell_Set( 0, kDetails_Master_Cell_X, kDetails_Master_Cell_Y, &cellParam);		// set up buttons, general	buttonParam.master = d->master;	buttonParam.visible = true;	buttonParam.enabled = true;	buttonParam.layer = 0;	buttonParam.whichTabSet = -1;	buttonParam.whichTab = -1;	buttonParam.minMaxBounds.left = 0;	buttonParam.minMaxBounds.top = 0;	buttonParam.minMaxBounds.right = kHUI_Pixel_Max;	buttonParam.minMaxBounds.bottom = kHUI_Pixel_Max;	buttonParam.space.left = 4;	buttonParam.space.top = 8;	buttonParam.space.bottom = 4;	buttonParam.fontStyle.flags = kControlUseFontMask | kControlUseSizeMask |		kControlUseFaceMask | kControlUseJustMask;	buttonParam.fontStyle.font = kSmallFontNum;	buttonParam.fontStyle.size = kSmallFontSize;	buttonParam.fontStyle.style = 0;	buttonParam.fontStyle.just = teCenter;	buttonParam.helpStringResID = -1;	buttonParam.enabledOnIndex = -1;	buttonParam.enabledOffIndex = -1;	buttonParam.disabledIndex = -1;	buttonParam.flags = huiControlFlag_none;	// set up text, general	textParam.master = d->master;	textParam.visible = true;	textParam.enabled = true;	textParam.layer = 0;	textParam.whichTabSet = -1;	textParam.whichTab = -1;	textParam.minMaxBounds.left = 0;	textParam.minMaxBounds.top = 0;	textParam.minMaxBounds.right = kHUI_Pixel_Max;	textParam.minMaxBounds.bottom = kHUI_Pixel_Max;	textParam.space.left = 8;	textParam.space.top = 10;	textParam.space.bottom = 4;	textParam.flags = huiControlFlag_none;	textParam.fontStyle.flags = kControlUseFontMask | kControlUseSizeMask |		kControlUseFaceMask;// | kControlUseJustMask;	textParam.fontStyle.font = gHera->smallFontNum;	textParam.fontStyle.size = gHera->smallFontSize;	textParam.fontStyle.style = 0;	textParam.fontStyle.just = -1;	textParam.helpStringResID = -1;	textParam.enabledOnIndex = -1;	textParam.enabledOffIndex = -1;	textParam.disabledIndex = -1;		// make selection list	buttonParam.id = kList_ID;	buttonParam.minMaxBounds.left = 160;	buttonParam.minMaxBounds.right = 160;	buttonParam.minMaxBounds.bottom = kHUI_Pixel_Max;//200;	buttonParam.minMaxBounds.top = 0;	buttonParam.minMaxBounds.bottom = 200;	buttonParam.cellx = kList_Cell_X;	buttonParam.celly = kList_Cell_Y;	buttonParam.special.listBox.ldesResID = 128;	buttonParam.special.listBox.refCon = 0;	buttonParam.flags = huiControlFlag_useCellV;	HUI_ListBox_New_LiteralP( &buttonParam);		buttonParam.minMaxBounds.left = 0;	buttonParam.minMaxBounds.top = 0;	buttonParam.minMaxBounds.right = kHUI_Pixel_Max;	buttonParam.minMaxBounds.bottom = kHUI_Pixel_Max;		// set up list buttons		if ( d->chooseOnly) buttonParam.enabled = false;	if ( d->chooseOnly) textParam.enabled = false;	buttonParam.id = kList_Add_Button_ID;	buttonParam.cellx =  kList_Button_Cell_X;	buttonParam.celly =  kList_Button_Cell_Y;	buttonParam.flags = huiControlFlag_none;	GetIndString( buttonParam.label, kHera_AppStrResID, 9);	HUI_PushButton_New_LiteralP( &buttonParam);		buttonParam.id = kList_Remove_Button_ID;	buttonParam.cellx =  kList_Button_Cell_X;	buttonParam.celly =  kList_Button_Cell_Y;	buttonParam.flags = huiControlFlag_none;	GetIndString( buttonParam.label, kHera_AppStrResID, 10);	HUI_PushButton_New_LiteralP( &buttonParam);	// set up action selection group		groupParam.master = d->mainMaster;	groupParam.visible = true;	groupParam.enabled = true;	groupParam.whichTabSet = -1;	groupParam.whichTab = -1;	groupParam.layer = 0;	groupParam.fontStyle.flags = kControlUseFontMask | kControlUseSizeMask |		kControlUseFaceMask;	groupParam.fontStyle.font = gHera->smallFontNum;	groupParam.fontStyle.size = gHera->smallFontSize;	groupParam.fontStyle.style = gHera->smallFontBoldStyle;	groupParam.helpStringResID = -1;	groupParam.id = kDetails_Type_Popup_ID;	groupParam.cellx = kDetails_Master_Cell_X;	groupParam.celly = kDetails_Master_Cell_X;	groupParam.special.menuStrList.strList = GetStringList( 571);	groupParam.fontStyle.style = gHera->smallFontStyle;	if ( d->chooseOnly) groupParam.enabled = false;	if ( groupParam.special.menuStrList.strList != nil)	{		groupParam.special.menuStrList.menuID = HU_GetNewMenuID();		groupParam.special.menuStrList.multiSelect = false;		SetRect( &groupParam.minMaxBounds, 0, 0, kHUI_Pixel_Max, kHUI_Pixel_Max);		GetIndString( groupParam.label, kStrResID, 1); // ignored		HUI_Group_PopupButton_New_StrList( &groupParam);//		HUI_Group_New_LiteralP( &groupParam);		ReleaseResource( groupParam.special.menuStrList.strList);	}		groupParam.enabled = true;	groupParam.fontStyle.style = gHera->smallFontBoldStyle;	groupParam.cellx = kData_Cell_X;	groupParam.celly = kData_Cell_Y;	groupParam.special.group.isSecondary = false;	GetIndString( groupParam.label, kStrResID, 5); // text	HUI_Group_New_LiteralP( &groupParam);		// set up argument master	masterParam.rowNum = kDetails_Master_RowNum;	masterParam.colNum = kDetails_Master_ColNum;	masterParam.layerNum = kDetails_Panel_Num;	d->details = HUI_MasterControl_New( d->mainMaster, 0, kDetails_Master_Cell_X,		kDetails_Master_Cell_Y, &masterParam);			mAssert( d->details != nil);	if ( d->details == nil) return memFullErr;	HUI_Master_HideLayer( d->details, 0);		d->details->tab[0][0].h = kTab_Width;	d->details->tab[0][0].hAlign = hui_halign_right;	d->details->tab[0][1].h = kTab_Width;	d->details->tab[0][1].hAlign = hui_halign_left;		Setup_Details_Panel( d, newWindow);		// set up data cell	buttonParam.master = d->mainMaster;	buttonParam.cellx = kData_Cell_X;	buttonParam.celly = kData_Cell_Y;	textParam.master = d->mainMaster;	textParam.cellx = kData_Cell_X;	textParam.celly = kData_Cell_Y;		// title label	textParam.id = kData_Title_Field - 1;	textParam.flags = huiControlFlag_none;	textParam.whichTabSet = 0;	textParam.whichTab = 0;	GetIndString( textParam.label, kStrResID, 1);	HUI_StaticText_New_LiteralP( &textParam);		// title field	textParam.id = kData_Title_Field;	textParam.flags = huiControlFlag_none;	textParam.whichTabSet = 0;	textParam.whichTab = 1;	textParam.label[0] = 0;	textParam.minMaxBounds.left = kEditTextBigFieldWidth;	HUI_StaticText_New_LiteralP( &textParam);	textParam.minMaxBounds.left = 0;	// title choose button	buttonParam.id = kData_Title_Choose_Button;	buttonParam.flags = huiControlFlag_none;	buttonParam.whichTabSet = -1;	buttonParam.whichTab = -1;	GetIndString( buttonParam.label, kStrResID, 7);	HUI_PushButton_New_LiteralP( &buttonParam);		// content label	textParam.id = kData_Content_Field - 1;	textParam.flags = huiControlFlag_newLine;	textParam.whichTabSet = 0;	textParam.whichTab = 0;	GetIndString( textParam.label, kStrResID, 2);	HUI_StaticText_New_LiteralP( &textParam);		// content field	textParam.id = kData_Content_Field;	textParam.flags = huiControlFlag_none;	textParam.whichTabSet = 0;	textParam.whichTab = 1;	textParam.label[0] = 0;	textParam.minMaxBounds.left = kEditTextBigFieldWidth;	HUI_StaticText_New_LiteralP( &textParam);	textParam.minMaxBounds.left = 0;	// content choose button	buttonParam.id = kData_Content_Choose_Button;	buttonParam.flags = huiControlFlag_none;	buttonParam.whichTabSet = -1;	buttonParam.whichTab = -1;	GetIndString( buttonParam.label, kStrResID, 8);	HUI_PushButton_New_LiteralP( &buttonParam);		strList = GetStringList( kHera_DefaultMainButtonStrResID);	if ( strList != nil)	{		HUI_Main_Buttons_H_Setup( d->master, 0,			kSeparator_Cell_X, kColNum, kSeparator_Cell_Y, 1,				true, strList);				ReleaseResource( strList);	}		ShowWindow( (WindowPtr)newWindow);	HUI_Master_Layout( d->master, (Point){0, 0}, (Point){0, 0});	HUI_Master_HideAllLayers_Deep( d->mainMaster);	HUI_Master_ShowAllLayers_Deep( d->mainMaster);	HUI_Master_ShowLayer( d->mainMaster, 0);	HUI_Master_ShowAllControls( d->mainMaster, 0, true);	for ( i = 0; i < kDetails_Panel_Num; i++)	{		HUI_Master_HideLayer( d->details, i);	}	d->brief.briefPointKind = kNoPointKind;	Setup_List( d);		d->whichBriefPoint = 0;	d->whichBriefPoint = HUI_Control_SetListValue( d->master, 0, kList_Cell_X, kList_Cell_Y,										kList_ID, d->whichBriefPoint);	Window_SetControls_FromBrief( d, newWindow, d->whichBriefPoint);	TypePopup_Change( d, d->brief.briefPointKind, true);		gHera->modalMode++;	if ( d->briefPointNum <= 0) Enable_Editing( d, false);			HUnlock( data);	return noErr;}